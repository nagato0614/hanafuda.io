# 開発タスク一覧

> **テスト方針**: ゲームロジックに関する変更はブラックボックス視点（公開 API 入出力）で検証する。内部状態に直接依存するテストは避ける。

## 0. 完了済み
- [x] 画面レイアウト骨格（1332x999 想定）の実装
- [x] Bootstrap 5 導入と主要コンポーネント（ログ・アクションパネル・モーダル）整備
- [x] Pinia ストアとバックエンドモックの連携、UI 上での対局フロー表示
- [x] ドメイン層骨格 `Deck` / `Field` / `PlayerState` / `RoundState` / `GameService`
- [x] `GameState` を介した UI 用スナップショット生成とカード描画補助
- [x] vitest によるドメイン E2E テスト（山札枯渇まで自動進行）

---

## 1. コアロジック拡張
### 1.1 ラウンド制御
- [x] 山札再配札条件（同月4枚・場全同月など）の検出と再配札手続き
- [ ] ラウンド終了後の先手決定・マッチ進行管理（複数局の履歴保持）
- [ ] 山札が尽きた際の流局処理とスコアリセット

### 1.2 役判定・得点
- [x] `YakuEvaluator` を実装し、最低限の役（五光/四光/雨四光/三光/猪鹿蝶/花見酒/月見酒/短冊/タネ/カス）を判定
- [x] `ScoreCalculator` で役点とコイコイ倍率の合算を行い、ラウンド終了時の得点差分を算出
- [x] `GameState` / `GameService` に役情報・得点を残すイベントログを追加

### 1.3 コイコイ管理
- [x] プレイヤー/CPU それぞれのコイコイ宣言状態を保持し、手番ごとに選択を促す
- [x] コイコイ宣言後の勝敗処理（上がり不可 / 相手倍付け）を実装
- [x] UI ログ・モーダルでコイコイ結果を通知

---

## 2. CPU 思考ロジック
- [x] 場と手札のマッチ候補から CPU の行動を選択するアルゴリズム（ヒューリスティックベース可）
- [x] CPU のコイコイ判断基準（自得点・相手得点差・残札枚数）
- [x] 自動手番処理を GameService / RoundState に統合し、UI からは一連のターンを再生できるようにする
- [x] CPU 行動をログへ記録し、UI のターン表示と同期

---

## 3. ストア & UI 調整
- [x] `GameState` と `useMatchStore` 間でスコア・役情報・コイコイ状態をやり取りするフィールドを追加
- [x] ログ表示のカテゴリ整理（info / success / warning / error）と最大件数制御の明文化
- [x] コイコイ選択 UI（モーダルまたはアクションボタン）を実装し、GameService の応答に従って遷移
- [x] CPU 手番時のハイライトや入力ロックなど、ターン制御を視覚的に反映

---

## 4. QA・テスト
- [ ] 役判定・得点計算・コイコイ処理に関するブラックボックステストを追加
- [ ] 再配札・流局など例外シナリオを含むテストケースを作成
- [ ] Playwright を用いた UI E2E テスト（1 局通しとコイコイ分岐）を整備
- [ ] 自動化テスト実行フローを npm scripts と CI（未定）に統合

---

## 5. ビジュアル・アクセシビリティ
- [ ] 役成立/コイコイ/ラウンド結果用のトースト・ダイアログ最終デザイン
- [ ] カードホバー/フォーカス時の通称表示とモバイル長押し対応
- [ ] 共通スタイルガイド文書化（色・余白・コンポーネント状態）
- [ ] キーボード操作・スクリーンリーダー対応状況の棚卸しと改善

---

## 6. 将来タスク (Phaser 移行準備)
- [ ] Vue ↔︎ Phaser のイベント境界とデータ移譲方針を設計
- [ ] Phaser シーン内でのカード描画・ドラッグ操作プロトタイプ
- [ ] Vue 側レイアウト縮小に向けたロードマップ策定

---

## 7. 現行実装の課題
- [ ] ラウンド終了ログ生成時に `event.result.statuses?.[0]?.round` を参照しているが、`statuses` には局番号が含まれず表示が空になるため、局番号の取得方法を見直す必要がある。
- [ ] `ScoreCalculator` は相手側のコイコイ回数を単純加算して倍率を算出しているため、複数回コイコイが発生すると想定以上に倍数が膨れ上がる恐れがある。プレイヤー別の倍率を個別に計算する仕組みが必要。
- [ ] CPU の手番選択は現状「捕獲できる最初の手」を固定で選ぶのみで戦略性が乏しく、役成立やリスク評価が考慮されていない。ヒューリスティックの強化が望まれる。
- [x] 場に8枚しか置けないので 8枚以上おいたときの配置を考え実装する
- [x] 場札または手札を一枚選択したあとキャンセルする機能の追加. もう一度同じ札を選択するとキャンセルする
- [x] 音声再生の追加

## 8. コイコイ体験の改善
- [ ] **コイコイ選択 UI の拡充**: 現状はアクションパネルのボタンのみで選択するため、成立役や獲得予定点が分かりにくい。`pendingKoikoi` の `newYaku` / `score` 情報を用いてモーダルを表示し、役一覧・現在倍率・上がり時の見込み点を提示する。
- [ ] **コイコイタイマーの実装**: `GameState` の `status.timeRemaining` が常に `'--'` のままなので、Koikoi 判定中はカウントダウンを表示し、時間切れ時のデフォルト動作（上がり or コイコイ）を定義する。UI とストアの両方にタイマー制御を追加する。
- [ ] **コイコイ状態の可視化強化**: ステータスバーや履歴に「コイコイ回数」「相手のコイコイ宣言状態」を明示するバッジを追加し、`match.history` にも Koikoi の有無を記録する。これにより、継続中の倍率やリスクが一目で分かるようにする。
- [ ] **Koikoi フローの自動テスト追加**: Pinia ストアを通じて `playSelectedCards` → `resolveKoikoi` → CPU 手番までをシミュレートするテストを作成し、選択解除や CPU 待機タイマーが期待通り動作するか検証する。

## 9. Phaser シーン描画タスク
- [ ] **Phaser レイヤの責務整理**: 現在背景のみになっている `PhaserGame` コンポーネントの役割を再定義し、カードスプライト描画・アニメーション制御・入力イベントをどこまで担当するかドキュメント化する。
- [ ] **カードスプライトの生成・管理**: Vue 側の手札/場札スナップショットから Phaser 用データ構造（位置・表裏・回転・ZIndex）を作り、`CardSpriteManager` のようなクラスでインスタンス化・再利用・破棄を行う。
- [ ] **配置座標とレイアウト**: 場札・手札・獲得札ごとの座標計算ロジックを実装し、画面サイズ変更や 4×2/5×2 レイアウト変更に追随できるよう補間を設計する。
- [ ] **アニメーションパイプライン**: カード移動（手札→場・場→獲得札・山札ドロー）を tween で表現する共通ユーティリティを作成し、アニメーション完了時に Vue に進捗通知が届くようイベントを発火する。
- [ ] **入力イベント連携**: Phaser 上でカードをクリック（またはタップ）した際に、対応するカード ID を Vue の `selectHandCard` / `selectFieldCard` へ伝えるイベントバスを実装。Phaser 側でヒット領域・無効状態の視覚表現も管理する。
- [ ] **描画と UI 同期のテスト**: Phaser シーンをスタブ化した統合テストを追加し、Vue からのカード選択 → Phaser イベント → ストア更新までの一連のシーケンスが動作することを検証する。
